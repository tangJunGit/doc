<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta name="renderer" content="webkit"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="#">
    <title>打包图</title>
    <style type="text/css">
        svg.pack{
            background: #eee;
        }
        .pack .nodes text{
            font-size: 10px;
            fill: black;
        }
    </style>
</head>
<body>
   <svg class="pack" width="400" height="400"></svg>

   <script src="https://d3js.org/d3.v4.min.js"></script>
   <script>
        // 获取svg信息
        var svg = d3.select('.pack')
            width = svg.attr('width'),
            height = svg.attr('height');

        // 延迟加载数据
        var color = d3.scaleSequential(d3.interpolatePlasma);

        d3.queue()
            .defer(d3.json, 'dataset/city.json')
            .await(function(err, json) {
                if (err) throw err;
                json = d3.hierarchy(json)
                        .sum(function(d) {
                            return d.value ? d.value : 1;
                        });

                // console.log(json);
                color.domain([-json.height,json.height])
                draw(json);
            });

        
        function draw(root) {
            var pack = d3.pack()
                        .size([width,height])
                        .padding(2);                // 间距

            // 创建每个包裹圆的g元素
            var update = svg.selectAll('g.nodes')
                            .data(pack(root).descendants());            // 排序
            console.log(pack(root).descendants());

            update.exit().remove();
            var g_nodes = update.enter()
                            .append('g')
                            .attr('class','nodes')
                            .merge(update)
                            .attr('transform', function(d) {
                                return 'translate(' + d.x + ',' + d.y + ')';
                            });

            // 绘画圆
            g_nodes.selectAll('circle').remove();
            var circles = g_nodes.append('circle')
                                .attr('r', function(d,i) {
                                    return d.r;
                                })
                                .style('fill', function(d) {
                                    return color(d.depth);
                                })
                                .on('mouseover',function(){
                                    d3.select(this)
                                        .attr('stroke','black')
                                        .attr('stroke-width',1);
                                })
                                .on('mouseout',function(){
                                    d3.select(this)
                                        .attr('stroke','null');
                                });
            // 绘画文本
            g_nodes.append('text')
                    .attr("dx", -12)
                    .attr("dy", 3)
                    .text(function(d){
                        return d.children ? '' : d.data.name;
                    });

            g_nodes.append('title')
                    .text(function(d) { 
                        return d.data.name;
                    });
            }

   </script>
</body>
</html>